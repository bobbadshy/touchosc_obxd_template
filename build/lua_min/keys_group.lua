--[[START keys_group.lua]]local a=self.parent.children.kbdSettings;local b=self.parent.children.buttons;local c=self.children.white.children;local d=self.children.black.children;local e=4;local f=0;local g=2;local h=16384*0.75;local i={c[1],d[1],c[2],d[2],c[3],c[4],d[3],c[5],d[4],c[6],d[5],c[7],c[8],d[6],c[9],d[7],c[10],c[11],d[8],c[12],d[9],c[13],d[10],c[14],c[15],d[11],c[16],d[12],c[17],c[18],d[13],c[19],d[14],c[20],d[15],c[21],c[22]}local j=1;local k=2;local l=3;local m=1;local n=2;local o=3;local p={}local q=0;local r=0;local s=63;local t=nil;local u=nil;local v=nil;local w=nil;local x=nil;local y=0;local z={0,0,0,0}local A=false;local B=false;local C=false;local D=false;local E=false;local F=false;local G=false;local H=false;local I=false;local J=false;local K=false;local L=false;local M=false;function init()setOctave(e)setTranspose(f)A=a.children.btnModulationHorz.values.x==1;B=a.children.btnModulationVert.values.x==1;C=a.children.btnPitchbendHorz.values.x==1;D=a.children.btnPitchbendVert.values.x==1;E=a.children.btnChannelPressureHorz.values.x==1;F=a.children.btnChannelPressureVert.values.x==1;G=a.children.btnPolyphonicHorz.values.x==1;H=a.children.btnPolyphonicVert.values.x==1;I=tonumber(a.children.midiCCHorz.tag)~=0;t=nil;J=tonumber(a.children.midiCCVert.tag)+tonumber(a.children.midiCCVert2.tag)+tonumber(a.children.midiCCVert3.tag)+tonumber(a.children.midiCCVert4.tag)>0;u=nil;v=nil;w=nil;x=nil;modulationSlider=a.children.btnModulationSlider.values.x==1;self.parent.children.modulationSlider.children.slider:notify('modulationSlider',modulationSlider)for N=1,#c do c[N]:notify('modEnabledHorz',A)c[N]:notify('modEnabledVert',B)c[N]:notify('pbEnabledHorz',C)c[N]:notify('pbEnabledVert',D)c[N]:notify('cAtEnabledHorz',E)c[N]:notify('cAtEnabledVert',F)c[N]:notify('atEnabledHorz',G)c[N]:notify('atEnabledVert',H)c[N]:notify('midiCCHorzEnabled',I)c[N]:notify('midiCCVertEnabled',J)c[N]:notify('pbSensitivity',g)c[N]:notify('pbMaxValue',h)end;for N=1,#d do d[N]:notify('modEnabledHorz',A)d[N]:notify('modEnabledVert',B)d[N]:notify('pbEnabledHorz',C)d[N]:notify('pbEnabledVert',D)d[N]:notify('cAtEnabledHorz',E)d[N]:notify('cAtEnabledVert',F)d[N]:notify('atEnabledHorz',G)d[N]:notify('atEnabledVert',H)d[N]:notify('midiCCHorzEnabled',I)d[N]:notify('midiCCVertEnabled',J)d[N]:notify('pbSensitivity',g)d[N]:notify('pbMaxValue',h)end end;function reset(O)s=63;if t==nil then t=a.children.midiCCHorz.children.midi.values.x end;y=t;if u==nil then u=a.children.midiCCVert.children.midi.values.x end;z[1]=u;if v==nil then v=a.children.midiCCVert2.children.midi.values.x end;z[2]=v;if w==nil then w=a.children.midiCCVert3.children.midi.values.x else a.children.midiCCVert3.children.midi.values.x=w end;z[3]=w;if x==nil then x=a.children.midiCCVert4.children.midi.values.x else a.children.midiCCVert4.children.midi.values.x=x end;z[4]=x;r=0;calcChannelPressure(63)calcModulation(0)end;function release()if q==0 then a.children.midiCCHorz.children.midi.values.x=t;a.children.midiCCVert.children.midi.values.x=u;a.children.midiCCVert2.children.midi.values.x=v end end;function applyToKeys()local P=e*12;for N=1,#i do local note=P+N-1+f;i[N].name=note;i[N].visible=note<=127;if p[tostring(note)]~=true then i[N].messages.MIDI[j].send=true else i[N].messages.MIDI[j].send=false end end;self.children.C0.values.text='C'..e-1;self.children.C1.values.text='C'..e;self.children.C2.values.text='C'..e+1;self.children.C3.values.text='C'..e+2 end;function applySustain(Q)for N=1,127 do note=c[N]if note==nil then note=d[N]end;if Q==127 then if note~=nil and note.values.touch then note.messages.MIDI[j].send=false;p[note.name]=true end elseif Q==0 then if note==nil then if p[tostring(N)]then local R=c[1].messages.MIDI[j]:data()R[2]=N;R[3]=0;sendMIDI(R)p[N]=nil end else if p[note.name]~=nil then note.messages.MIDI[j].send=true;if not note.values.touch then note.messages.MIDI[j]:trigger()end;p[N]=nil end end end end end;function setOctave(S)e=S;applyToKeys()end;function setTranspose(S)f=S;applyToKeys()end;function setChannel(S)local T=S-1;for N=1,#i do i[N].tag=T end end;function calcChannelPressure(S)s=0.5*(s+S)local R=self.messages.MIDI[n]:data()R[2]=s;sendMIDI(R)end;function calcModulation(S)r=0.5*(r+S)local R=self.messages.MIDI[o]:data()R[3]=r;sendMIDI(R)end;function calcMidiCCHorz(S,U)local V=a.children.midiCCHorzScale.values.x^2;V=(V-0.5)*2;V=V<0 and-1.8*V^2-0.2 or 1.8*V^2+0.2;U.values.x=math.min(1,math.max(0,y+V*S))end;function calcMidiCCVert(S,O,U,W)local V=W.values.x;V=(V-0.5)*2;V=V<0 and-1.8*V^2-0.2 or 1.8*V^2+0.2;U.values.x=math.min(1,math.max(0,z[O]+V*S))end;function onReceiveNotify(X,S)if X=='pressure'then calcChannelPressure(S)elseif X=='press'then q=q+1;if q==1 then reset()end elseif X=='release'then q=q-1;if q==0 then release()end elseif X=='modulation'then calcModulation(S)elseif X=='midiCCHorz'then calcMidiCCHorz(S,a.children.midiCCHorz.children.midi)elseif X=='midiCCVert'then if tonumber(a.children.midiCCVert.tag)>0 then calcMidiCCVert(S,1,a.children.midiCCVert.children.midi,a.children.midiCCVertScale)end;if tonumber(a.children.midiCCVert2.tag)>0 then calcMidiCCVert(S,2,a.children.midiCCVert2.children.midi,a.children.midiCCVertScale2)end;if tonumber(a.children.midiCCVert3.tag)>0 then calcMidiCCVert(S,3,a.children.midiCCVert3.children.midi,a.children.midiCCVertScale3)end;if tonumber(a.children.midiCCVert4.tag)>0 then calcMidiCCVert(S,4,a.children.midiCCVert4.children.midi,a.children.midiCCVertScale4)end elseif X=='sustain'then applySustain(S)elseif X=='octave'then setOctave(S)elseif X=='transpose'then setTranspose(S)elseif X=='channel'then setChannel(S-1)elseif X=='modEnabled'then for N=1,#c do c[N]:notify('modEnabled',S)end;for N=1,#d do c[N]:notify('modEnabled',S)end elseif X=='settings'then init()end end--[[END keys_group.lua]]