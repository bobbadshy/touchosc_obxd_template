local a=2;local b=3;local c=self.frame.w;local d=self.frame.h;local e=c/2;local f=true;local g=true;local h=false;local i=false;local j=false;local k=false;local l=false;local m=false;local n=2;local o=8192*0.75;local p=0;local q=0;local r=0;local s=8192;function onReceiveNotify(t,u)if t=='pbEnabledHorz'then print('pbEnabledHorz '..tostring(h))h=u elseif t=='atEnabledHorz'then print('atEnabledHorz '..tostring(l))l=u elseif t=='cAtEnabledHorz'then print('cAtEnabledHorz '..tostring(j))j=u elseif t=='modEnabledHorz'then print('modEnabledHorz '..tostring(f))f=u elseif t=='pbEnabledVert'then print('pbEnabledVert '..tostring(i))i=u elseif t=='atEnabledVert'then print('atEnabledVert '..tostring(m))m=u elseif t=='cAtEnabledVert'then print('cAtEnabledVert '..tostring(k))k=u elseif t=='modEnabledVert'then print('modEnabledVert '..tostring(g))g=u elseif t=='pbSensitivity'then n=u elseif t=='pbMaxValue'then o=u end end;function onValueChanged(v)if v=='touch'then if self.values.touch then p=0;q=0;r=0;s=8192;self.parent.parent:notify('press')else self.parent.parent:notify('release')end end end;function onPointer(w)local x=w[1]local y=x.state;if y==PointerState.BEGIN then e=x.x;start_y=x.y elseif y==PointerState.END then if h then self.messages.MIDI[2]:trigger()end elseif y==PointerState.MOVE then if h then applyPitchBend(x.x-e,c)end;if i then applyPitchBend(start_y-x.y,d)end;if f then applyModulation(x.x,e,c)end;if g then applyModulation(x.y,start_y,d)end;if j then applyChannelAftertouch(x.x,e)end;if k then applyChannelAftertouch(x.y,start_y)end;if l then applyAftertouch(x.x,e)end;if m then applyAftertouch(x.y,start_y)end end end;function applyPitchBend(z,A)local B=z/(A/2)local C=math.min(1,math.abs(B)^n)*o;if math.abs(s-C)<s*0.01 then return end;if B<=0 then C=8192-C else C=8192+C end;C=math.max(0,math.min(16383,C))s=0.5*(s+C)local D=self.messages.MIDI[a]:data()D[2]=math.floor(math.fmod(C,128))D[3]=math.floor(C/128)sendMIDI(D)end;function applyAftertouch(E,A)local B=E/A;local C=math.min(1,math.max(0,B))if C==p then return end;p=C;local D=self.messages.MIDI[b]:data()D[3]=math.floor(C*127)sendMIDI(D)end;function applyChannelAftertouch(E,A)local B=E/A;local C=math.min(1,math.max(0,B))C=math.floor(C*127)if C==q then return end;q=C;self.parent.parent:notify('pressure',q)end;function applyModulation(E,F,A)local B=math.abs(2*((E-F)/A)^2)local C=math.min(1,math.max(0,B))C=math.floor(C*127)if C==r then return end;r=C;self.parent.parent:notify('modulation',r)end
