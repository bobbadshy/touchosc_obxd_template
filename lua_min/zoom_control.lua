local a=300;local b=0;local c=false;local d=1.2;local e=false;function onValueChanged(f)if f=='touch'and not self.values.touch then local g=getMillis()if g-b<a then if not e then e=true end;if e then toggleZoom()end;b=0 else b=g end end end;local h,i,j,k;local l=0;local m=.95;local n=3;local o;local p=self.parent.children.app;local q=p.frame;local r=self.parent.frame;local s={}function initLabelCache(t)if t.type==ControlType.LABEL or t.type==ControlType.TEXT then s[t.ID]=t.textSize end;for u=1,#t.children do initLabelCache(t.children[u])end end;initLabelCache(p)function update()if o then q.x=q.x+o.dx;q.y=q.y+o.dy;o.dx=o.dx*m;o.dy=o.dy*m;if math.abs(o.dx)<n then o.dx=0 end;if math.abs(o.dy)<n then o.dy=0 end;if o.dx==0 and o.dy==0 then o=nil end;if q.x>=0 then q.x=0;o=nil elseif q.x+q.w<=r.w then q.x=r.w-q.w;o=nil end;if q.y>=0 then q.y=0;o=nil elseif q.y+q.h<=r.h then q.y=r.h-q.h;o=nil end end end;function scaleRec(t,v)t.frame.w=t.frame.w*v;t.frame.h=t.frame.h*v;t.frame.x=t.frame.x*v;t.frame.y=t.frame.y*v;if t.type==ControlType.LABEL or t.type==ControlType.TEXT then local w=s[t.ID]*v;s[t.ID]=w;t.textSize=w end;local x=t.children;for u=1,#x do scaleRec(x[u],v)end end;function calcDistance(y,z,A,B)local C=y-z;local D=A-B;return math.sqrt(C*C+D*D)end;function calcMid(y,z,A,B)return{x=y+(z-y)/2,y=A+(B-A)/2}end;function zoomTo(v,E)local F=q.w*v;local G=q.h*v;if F<r.w then v=r.w/q.w;F=r.w;G=q.h*v end;if F~=q.w then q.x=q.x-(F-q.w)*E.x/q.w;q.y=q.y-(G-q.h)*E.y/q.h;q.w=F;q.h=G;if q.x>0 then q.x=0 elseif q.x+q.w<r.w then q.x=r.w-q.w end;if q.y>0 then q.y=0 elseif q.y+q.h<r.h then q.y=r.h-q.h end;for u=1,#p.children do scaleRec(p.children[u],v)end end end;function pan(H,I)q.x=j.x+H-i.x;q.y=j.y+I-i.y;if q.x>0 then i.x=i.x+q.x;q.x=0 elseif q.x+q.w<r.w then local J=r.w-q.x-q.w;q.x=r.w-q.w;i.x=i.x-J end;if q.y>0 then i.y=i.y+q.y;q.y=0 elseif q.y+q.h<r.h then local J=r.h-q.y-q.h;q.y=r.h-q.h;i.y=i.y-J end end;function endAll()i=nil;j=nil;h=nil;pointnum=0 end;function onPointer(K)if K[1].state==PointerState.END or#self.pointers~=pointnum then pointnum=#self.pointers;if#self.pointers==2 then if K[1].state==PointerState.END then k=nil;endAll()else o=nill;h=calcDistance(self.pointers[1].x,self.pointers[2].x,self.pointers[1].y,self.pointers[2].y)end elseif#self.pointers==1 then if K[1].state==PointerState.END then if k then local L=K[1].x-k.x;local M=K[1].y-k.y;if math.abs(L)>n or math.abs(M)>n then o={dx=L,dy=M}end end;k=nil;endAll()else o=nil;i={x=self.pointers[1].x,y=self.pointers[1].y}k={x=self.pointers[1].x,y=self.pointers[1].y}j={x=q.x,y=q.y}end end elseif K[1].state==PointerState.MOVE then if#self.pointers==1 then pan(self.pointers[1].x,self.pointers[1].y)k={x=self.pointers[1].x,y=self.pointers[1].y}end end end;function toggleZoom()local N=350;local O=d;if not c then if self.pointers[1]~=nil then xx=self.pointers[1].x;if xx<N then xx=0 elseif r.w-xx<N then xx=r.w end;yy=self.pointers[1].y;if yy<N then yy=0 elseif r.h-yy<N then yy=r.h end else xx=q.w/2*O;yy=q.h/2*O end;zoomTo(r.w*O/q.w*O,{x=xx,y=yy})else zoomTo(r.w/q.w,{x=q.w/2,y=q.h/2})end;c=not c end;function reset()o=nil;zoomTo(r.w/q.w,{x=q.w/2,y=q.h/2})q.x=0;q.y=0;endAll()end;function onReceiveNotify(f,P)if f=='reset'then reset()end;e=false;c=false end
