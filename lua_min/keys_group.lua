local a=self.children.white.children;local b=self.children.black.children;local c=4;local d=0;local e=1;local f=8192*0.75;local g={a[1],b[1],a[2],b[2],a[3],a[4],b[3],a[5],b[4],a[6],b[5],a[7],a[8],b[6],a[9],b[7],a[10],a[11],b[8],a[12],b[9],a[13],b[10],a[14],a[15],b[11],a[16],b[12],a[17],a[18],b[13],a[19],b[14],a[20],b[15],a[21],a[22]}local h=1;local i=2;local j=3;local k=1;local l=2;local m=3;local n={}local o=0;local p=0;local q=63;function init()print('init')setOctave(c)setTranspose(d)for r=1,#a do a[r]:notify('pbSensitivity',e)a[r]:notify('pbMaxValue',f)end;for r=1,#b do b[r]:notify('pbSensitivity',e)b[r]:notify('pbMaxValue',f)end end;function reset(s)o=0;q=63;p=0;calcChannelPressure(63)calcModulation(0)end;function applyToKeys()local t=c*12;for r=1,#g do local note=t+r-1+d;g[r].name=note;g[r].visible=note<=127;if n[tostring(note)]~=true then g[r].messages.MIDI[h].send=true else g[r].messages.MIDI[h].send=false end end;self.children.C0.values.text='C'..c-1;self.children.C1.values.text='C'..c;self.children.C2.values.text='C'..c+1;self.children.C3.values.text='C'..c+2 end;function applySustain(u)for r=1,127 do note=a[r]if note==nil then note=b[r]end;if u==127 then if note~=nil and note.values.touch then note.messages.MIDI[h].send=false;n[note.name]=true end elseif u==0 then if note==nil then if n[tostring(r)]then local v=a[1].messages.MIDI[h]:data()v[2]=r;v[3]=0;sendMIDI(v)n[r]=nil end else if n[note.name]~=nil then note.messages.MIDI[h].send=true;if not note.values.touch then note.messages.MIDI[h]:trigger()end;n[r]=nil end end end end end;function setOctave(w)c=w;applyToKeys()end;function setTranspose(w)d=w;applyToKeys()end;function setChannel(w)local x=w-1;for r=1,#g do g[r].tag=x end end;function calcChannelPressure(w)q=0.5*(q+w)local v=self.messages.MIDI[l]:data()v[2]=q;sendMIDI(v)end;function calcModulation(w)p=0.5*(p+w)local v=self.messages.MIDI[m]:data()v[3]=p;sendMIDI(v)end;function onReceiveNotify(y,w)if y=='pressure'then calcChannelPressure(w)elseif y=='press'then o=o+1 elseif y=='release'then o=o-1;if o<=0 then reset()end elseif y=='modulation'then calcModulation(w)elseif y=='sustain'then applySustain(w)elseif y=='octave'then setOctave(w)elseif y=='transpose'then setTranspose(w)elseif y=='channel'then setChannel(w-1)end end
