local a=self.children.white.children;local b=self.children.black.children;local c=4;local d=0;local e=1;local f=8192*0.75;local g={a[1],b[1],a[2],b[2],a[3],a[4],b[3],a[5],b[4],a[6],b[5],a[7],a[8],b[6],a[9],b[7],a[10],a[11],b[8],a[12],b[9],a[13],b[10],a[14],a[15],b[11],a[16],b[12],a[17],a[18],b[13],a[19],b[14],a[20],b[15],a[21],a[22]}local h=1;local i=2;local j=3;local k={}function init()print('init')setOctave(c)setTranspose(d)for l=1,#a do a[l]:notify('pbSensitivity',e)a[l]:notify('pbMaxValue',f)end;for l=1,#b do b[l]:notify('pbSensitivity',e)b[l]:notify('pbMaxValue',f)end end;function applyToKeys()local m=c*12;for l=1,#g do local note=m+l-1+d;g[l].name=note;g[l].visible=note<=127;if k[tostring(note)]~=true then g[l].messages.MIDI[h].send=true else g[l].messages.MIDI[h].send=false end end;self.children.C0.values.text='C'..c-1;self.children.C1.values.text='C'..c;self.children.C2.values.text='C'..c+1;self.children.C3.values.text='C'..c+2 end;function applySustain(n)for l=1,127 do note=a[l]if note==nil then note=b[l]end;if n==127 then if note~=nil and note.values.touch then note.messages.MIDI[h].send=false;k[note.name]=true end elseif n==0 then if note==nil then if k[tostring(l)]then local o=a[1].messages.MIDI[h]:data()o[2]=l;o[3]=0;sendMIDI(o)k[tostring(l)]=nil end else if k[note.name]~=nil then note.messages.MIDI[h].send=true;if not note.values.touch then note.messages.MIDI[h]:trigger()end;k[tostring(l)]=nil end end end end end;function setOctave(p)c=p;applyToKeys()end;function setTranspose(p)d=p;applyToKeys()end;function setChannel(p)local q=p-1;for l=1,#g do g[l].tag=q end end;function onReceiveNotify(r,p)if r=='sustain'then applySustain(p)elseif r=='octave'then setOctave(p)elseif r=='transpose'then setTranspose(p)elseif r=='channel'then setChannel(p-1)end end
