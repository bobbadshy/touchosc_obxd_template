local a=self.parent.children.kbdSettings;local b=self.parent.children.buttons;local c=self.children.white.children;local d=self.children.black.children;local e=4;local f=0;local g=2;local h=16384*0.75;local i={c[1],d[1],c[2],d[2],c[3],c[4],d[3],c[5],d[4],c[6],d[5],c[7],c[8],d[6],c[9],d[7],c[10],c[11],d[8],c[12],d[9],c[13],d[10],c[14],c[15],d[11],c[16],d[12],c[17],c[18],d[13],c[19],d[14],c[20],d[15],c[21],c[22]}local j=1;local k=2;local l=3;local m=1;local n=2;local o=3;local p={}local q=0;local r=0;local s=63;local t=nil;local u=nil;local v=0;local w=0;local x=false;local y=false;local z=false;local A=false;local B=false;local C=false;local D=false;local E=false;local F=false;local G=false;function init()setOctave(e)setTranspose(f)x=a.children.btnModulationHorz.values.x==1;y=a.children.btnModulationVert.values.x==1;z=a.children.btnPitchbendHorz.values.x==1;A=a.children.btnPitchbendVert.values.x==1;B=a.children.btnChannelPressureHorz.values.x==1;C=a.children.btnChannelPressureVert.values.x==1;D=a.children.btnPolyphonicHorz.values.x==1;E=a.children.btnPolyphonicVert.values.x==1;F=tonumber(a.children.midiCCHorz.children.label.values.text)~=0;G=tonumber(a.children.midiCCVert.children.label.values.text)~=0;t=nil;u=nil;modulationSlider=a.children.btnModulationSlider.values.x==1;self.parent.children.modulationSlider.children.slider:notify('modulationSlider',modulationSlider)for H=1,#c do c[H]:notify('modEnabledHorz',x)c[H]:notify('modEnabledVert',y)c[H]:notify('pbEnabledHorz',z)c[H]:notify('pbEnabledVert',A)c[H]:notify('cAtEnabledHorz',B)c[H]:notify('cAtEnabledVert',C)c[H]:notify('atEnabledHorz',D)c[H]:notify('atEnabledVert',E)c[H]:notify('midiCCHorzEnabled',F)c[H]:notify('midiCCVertEnabled',G)c[H]:notify('pbSensitivity',g)c[H]:notify('pbMaxValue',h)end;for H=1,#d do d[H]:notify('modEnabledHorz',x)d[H]:notify('modEnabledVert',y)d[H]:notify('pbEnabledHorz',z)d[H]:notify('pbEnabledVert',A)d[H]:notify('cAtEnabledHorz',B)d[H]:notify('cAtEnabledVert',C)d[H]:notify('atEnabledHorz',D)d[H]:notify('atEnabledVert',E)d[H]:notify('midiCCHorzEnabled',F)d[H]:notify('midiCCVertEnabled',G)d[H]:notify('pbSensitivity',g)d[H]:notify('pbMaxValue',h)end end;function reset(I)s=63;if t==nil then t=a.children.midiCCHorz.children.midiValue.values.x end;v=t;if u==nil then u=a.children.midiCCVert.children.midiValue.values.x end;w=u;r=0;calcChannelPressure(63)calcModulation(0)end;function release()if q==0 then a.children.midiCCHorz.children.midiValue.values.x=t;a.children.midiCCVert.children.midiValue.values.x=u end end;function applyToKeys()local J=e*12;for H=1,#i do local note=J+H-1+f;i[H].name=note;i[H].visible=note<=127;if p[tostring(note)]~=true then i[H].messages.MIDI[j].send=true else i[H].messages.MIDI[j].send=false end end;self.children.C0.values.text='C'..e-1;self.children.C1.values.text='C'..e;self.children.C2.values.text='C'..e+1;self.children.C3.values.text='C'..e+2 end;function applySustain(K)for H=1,127 do note=c[H]if note==nil then note=d[H]end;if K==127 then if note~=nil and note.values.touch then note.messages.MIDI[j].send=false;p[note.name]=true end elseif K==0 then if note==nil then if p[tostring(H)]then local L=c[1].messages.MIDI[j]:data()L[2]=H;L[3]=0;sendMIDI(L)p[H]=nil end else if p[note.name]~=nil then note.messages.MIDI[j].send=true;if not note.values.touch then note.messages.MIDI[j]:trigger()end;p[H]=nil end end end end end;function setOctave(M)e=M;applyToKeys()end;function setTranspose(M)f=M;applyToKeys()end;function setChannel(M)local N=M-1;for H=1,#i do i[H].tag=N end end;function calcChannelPressure(M)s=0.5*(s+M)local L=self.messages.MIDI[n]:data()L[2]=s;sendMIDI(L)end;function calcModulation(M)r=0.5*(r+M)local L=self.messages.MIDI[o]:data()L[3]=r;sendMIDI(L)end;function calcMidiCCHorz(M,O)O.values.x=math.min(1,math.max(0,v+(a.children.midiCCHorzScale.values.x+0.05)*2*M))end;function calcMidiCCVert(M,O)O.values.x=math.min(1,math.max(0,w+(a.children.midiCCVertScale.values.x+0.05)*2*M))end;function onReceiveNotify(P,M)if P=='pressure'then calcChannelPressure(M)elseif P=='press'then q=q+1;if q==1 then reset()end elseif P=='release'then q=q-1;release()elseif P=='modulation'then calcModulation(M)elseif P=='midiCCHorz'then calcMidiCCHorz(M,a.children.midiCCHorz.children.midiValue)elseif P=='midiCCVert'then calcMidiCCVert(M,a.children.midiCCVert.children.midiValue)elseif P=='sustain'then applySustain(M)elseif P=='octave'then setOctave(M)elseif P=='transpose'then setTranspose(M)elseif P=='channel'then setChannel(M-1)elseif P=='modEnabled'then for H=1,#c do c[H]:notify('modEnabled',M)end;for H=1,#d do c[H]:notify('modEnabled',M)end elseif P=='settings'then init()end end
