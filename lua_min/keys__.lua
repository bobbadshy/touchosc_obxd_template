local a=2;local b=3;local c=self.frame.w;local d=self.frame.h;local e=c/2;local f=true;local g=true;local h=false;local i=false;local j=false;local k=false;local l=false;local m=false;local n=2;local o=8192*0.75;local p=0;local q=0;local r=0;local s=8192;function onReceiveNotify(t,u)if t=='pbEnabledHorz'then print('pbEnabledHorz '..tostring(h))h=u elseif t=='atEnabledHorz'then print('atEnabledHorz '..tostring(l))l=u elseif t=='cAtEnabledHorz'then print('cAtEnabledHorz '..tostring(j))j=u elseif t=='modEnabledHorz'then print('modEnabledHorz '..tostring(f))f=u elseif t=='pbEnabledVert'then print('pbEnabledVert '..tostring(i))i=u elseif t=='atEnabledVert'then print('atEnabledVert '..tostring(m))m=u elseif t=='cAtEnabledVert'then print('cAtEnabledVert '..tostring(k))k=u elseif t=='modEnabledVert'then print('modEnabledVert '..tostring(g))g=u elseif t=='pbSensitivity'then n=u elseif t=='pbMaxValue'then o=u end end;function onValueChanged(v)if v=='touch'then if self.values.touch then p=0;q=0;r=0;s=8192;self.parent.parent:notify('press')else self.parent.parent:notify('release')end end end;function onPointer(w)local x=w[1]local y=x.state;if y==PointerState.BEGIN then e=x.x;start_y=x.y elseif y==PointerState.END then if h then self.messages.MIDI[2]:trigger()end elseif y==PointerState.MOVE then if h then applyPitchBend(x.x,e,c)end;if i then applyPitchBend(x.y,start_y,d)end;if f then applyModulation(x.x,e,c)end;if g then applyModulation(x.y,start_y,d)end;if j then applyChannelAftertouch(x.x,e)end;if k then applyChannelAftertouch(x.y,start_y)end;if l then applyAftertouch(x.x,e)end;if m then applyAftertouch(x.y,start_y)end end end;function applyPitchBend(z,A,B)local C=(z-A)/(B/2)local D=math.min(1,math.abs(C)^n)*o;if math.abs(s-D)<s*0.01 then return end;if C<=0 then D=8192-D else D=8192+D end;D=math.max(0,math.min(16383,D))s=0.5*(s+D)local E=self.messages.MIDI[a]:data()E[2]=math.floor(math.fmod(D,128))E[3]=math.floor(D/128)sendMIDI(E)end;function applyAftertouch(z,B)local C=z/B;local D=math.min(1,math.max(0,C))if D==p then return end;p=D;local E=self.messages.MIDI[b]:data()E[3]=math.floor(D*127)sendMIDI(E)end;function applyChannelAftertouch(z,B)local C=z/B;local D=math.min(1,math.max(0,C))D=math.floor(D*127)if D==q then return end;q=D;self.parent.parent:notify('pressure',q)end;function applyModulation(z,A,B)local C=math.abs(2*((z-A)/B)^2)local D=math.min(1,math.max(0,C))D=math.floor(D*127)if D==r then return end;r=D;self.parent.parent:notify('modulation',r)end
